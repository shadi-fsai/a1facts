# a1facts Test Plan

This document outlines the testing strategy for the `a1facts` project. The goal is to ensure the reliability, correctness, and performance of the knowledge base system.

## 1. Testing Scope

The testing process will cover the following key components:

-   **Ontology**: Loading, validation, and tool generation.
-   **Graph Database**: Functionality of both `NetworkX` and `Neo4j` backends.
-   **Knowledge Graph**: High-level graph operations and agent interactions.
-   **Knowledge Acquirer**: Knowledge extraction from various sources.
-   **Knowledge Base**: End-to-end functionality.

## 2. Testing Levels

### 2.1. Unit Tests

Unit tests will focus on isolating and testing individual components in detail.

-   **Ontology (`KnowledgeOntology`)**:
    -   Test loading a valid ontology from a YAML file.
    -   Test handling of invalid or malformed ontology files.
    -   Test `find_entity_class` for existing and non-existing classes.
    -   Test the generation of tools for adding, updating, and querying entities and relationships.

-   **Ontology Rewrite Agent (`OntologyRewriteAgent`)**:
    -   Test that the `rewrite_query` method correctly replaces placeholders in a template string with specific details from a mock ontology.

-   **Graph Database (`NetworkxGraphDatabase`, `Neo4jGraphDatabase`)**:
    -   Test adding, updating, and retrieving entities.
    -   Test all operations on an empty graph and a populated graph to ensure correct state handling.
    -   Test adding and retrieving relationships.
    -   Test property handling for both entities and relationships.
    -   Test primary key constraints.
    -   Test `get_all_entities_by_label`.
    -   Test graph save/load functionality (for NetworkX).
    -   Test connection and disconnection (for Neo4j).

-   **Knowledge Acquirer (`KnowledgeAcquirer`)**:
    -   **Configuration and Initialization**:
        -   Test loading a valid configuration with multiple knowledge sources (`function`, `mcp`).
        -   Test loading an empty configuration file or one without a `knowledge_sources` key.
        -   Test that `ValueError` is raised if a source is missing the required `type` field.
        -   Test graceful handling of unknown source types.
        -   Verify that the internal `Agent` is initialized with the correct tools, including `ExaTools` (if enabled), tools from knowledge sources, and tools from the `KnowledgeGraph`.

    -   **Acquisition Instruction Generation (`get_acquisition_instructions`)**:
        -   Using a mock `OntologyRewriteAgent`, verify it's called with the correct template string.
        -   Verify that the final instructions match the output of the rewrite agent.

    -   **Instruction Caching Logic**:
        -   **Cache Creation**: On first run with a new ontology, confirm the `OntologyRewriteAgent` is called and a `acquirer_instructions.pickle` file is created.
        -   **Cache Hit**: On a subsequent run with the *same* ontology, confirm the rewrite agent is *not* called and instructions are loaded from the pickle file.
        -   **Cache Invalidation**: On a subsequent run with a *modified* ontology, confirm the rewrite agent *is* called again and the cache is updated.
        -   **Cache Corruption**: Test with a corrupt or empty pickle file to ensure the system handles the error and regenerates the instructions.

    -   **Knowledge Acquisition (`acquire`)**:
        -   Mock the internal `agno.Agent`.
        -   Verify the `agent.run()` method is called with the exact query provided.
        -   Verify that the `content` of the `agent.run()` result is returned.

### 2.2. Integration Tests

Integration tests will verify the interactions between different components.

-   **Ontology and Knowledge Graph**:
    -   Test that the `KnowledgeGraph` correctly initializes with a given `KnowledgeOntology`.
    -   Test that the tools generated by the ontology work correctly when used by the `KnowledgeGraph`'s query and update agents.

-   **Knowledge Graph and Graph Database**:
    -   Test that `KnowledgeGraph` operations (querying, updating) are correctly translated into operations on the underlying graph database (both NetworkX and Neo4j).

-   **Knowledge Acquirer and Knowledge Graph**:
    -   Test that the `KnowledgeAcquirer` can successfully use the `KnowledgeGraph` as a tool to retrieve information.
    -   Test the end-to-end flow of acquiring knowledge and ingesting it into the `KnowledgeGraph`.
    -   Test that new information from a highly reliable source updates existing, less reliable information in the graph.
    -   Test that new information extends existing entities with new properties or relationships.

-   **Ontology, Acquirer, and Graph Integration**:
    -   Test that the `KnowledgeAcquirer`'s prompt rewriting is driven by the specific `KnowledgeOntology` it is initialized with.
        -   **Scenario 1**: Initialize the system with `ontology_A.yml`. Capture the rewritten acquisition instructions. Verify they contain specific terms and entity names from `ontology_A`.
        -   **Scenario 2**: Initialize the system with a different `ontology_B.yml`. Capture the rewritten instructions. Verify they are *different* from Scenario 1 and contain specific terms from `ontology_B`.

### 2.3. End-to-End (E2E) Tests

E2E tests will simulate real-world usage scenarios.

-   **`KnowledgeBase`**:
    -   Test the complete lifecycle:
        1.  Initialize a `KnowledgeBase` with a sample ontology and knowledge sources.
        2.  Query the empty graph to ensure it returns no results.
        3.  Use `acquire_knowledge_for_query` to populate the graph.
        4.  Use `query` to retrieve the newly added information.
        5.  Use `ingest_knowledge` to add more data.
        6.  Query the graph again to verify the ingested data.
    -   Test with both NetworkX and Neo4j backends.
    -   Test complex queries that require reasoning over multiple entities and relationships.

## 3. Test Environment and Tooling

-   **Test Framework**: `pytest` will be used as the primary testing framework.
-   **Mocking**: `unittest.mock` will be used to mock external dependencies and isolate components.

## 4. Test Data

-   **Sample Ontologies**: A set of sample ontology YAML files will be created to cover different schemas and edge cases.
-   **Mock Knowledge Sources**: Mock knowledge source configurations will be used to simulate different data providers.

## 5. Implementation Execution Plan

Based on the existing tests in `lib/tests/`, this is the execution plan to achieve full test coverage as defined in this document.

### Phase 1: Core Component Unit Tests
*   **[DONE] `KnowledgeAcquirer` (`lib/src/a1facts/enrichment/knowledge_acquirer.py`)**:
    *   **[DONE]** Create `lib/tests/enrichment/test_knowledge_acquirer.py`.
    *   **[DONE]** Implement tests for **Configuration and Initialization**.
    *   **[DONE]** Implement tests for **Acquisition Instruction Generation**.
    *   **[DONE]** Implement tests for **Instruction Caching Logic**.
    *   **[DONE]** Implement tests for **Knowledge Acquisition** orchestration.
*   **[DONE] `OntologyRewriteAgent` (`lib/src/a1facts/ontology/ontology_rewrite_agent.py`)**:
    *   **[DONE]** Create `lib/tests/ontology/test_ontology_rewrite_agent.py`.
    *   **[DONE]** Implement tests to verify placeholder replacement logic.
*   **[DONE] `KnowledgeGraph` (`lib/src/a1facts/graph/knowledge_graph.py`)**:
    *   **[DONE]** Create `lib/tests/graph/test_knowledge_graph.py`.
    *   **[DONE]** Implement tests for initialization.
    *   **[DONE]** Implement tests for `query()` and `update_knowledge()` methods, mocking the internal agents (`QueryAgent`, `UpdateAgent`).

### Phase 2: Integration Tests
*   **[DONE]** Create a new directory `lib/tests/integration/`.
*   **[DONE] `test_ontology_acquirer_integration.py`**:
    *   **[DONE]** Implement the "Ontology, Acquirer, and Graph Integration" test cases to ensure prompts are rewritten based on the ontology.
*   **[DONE] `test_acquirer_graph_integration.py`**:
    *   **[DONE]** Implement the "Knowledge Acquirer and Knowledge Graph" test cases.
    *   **[DONE]** Focus on verifying that acquired knowledge correctly updates the graph (both NetworkX and mocked Neo4j).

### Phase 3: E2E and Finalization
*   **[DONE] Review `lib/tests/e2e/test.py`**:
    *   **[DONE]** Analyze the existing E2E tests.
    *   **[DONE]** Augment the tests to explicitly cover the full `KnowledgeBase` lifecycle defined in section 2.3, including testing with an empty graph.
*   **[DONE] Review Existing Unit Tests**:
    *   **[DONE]** Briefly review the tests in `lib/tests/graph/` and `lib/tests/ontology/` to ensure they fully cover the points in the test plan. Add any missing cases.

